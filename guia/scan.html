<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Escanear QR — Guía La Casa del Duende</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex, nofollow" />
  <!-- Si tenés CSS global, descomentá -->
  <!-- <link rel="stylesheet" href="/style.css"> -->
  <style>
    :root{
      --bg:#0b0b0b; --panel:#101010; --ink:#eaeaea; --muted:#b9b9b9;
      --accent:#3cb371; --accent-2:#1d3127; --border:#2a2a2a; --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0; background:var(--bg); color:var(--ink); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{max-width:900px; margin:0 auto; padding:1rem}
    h1{font-weight:800; font-size:1.6rem; margin:.25rem 0 1rem}
    .card{background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); padding:1rem}
    #reader{width:100%; aspect-ratio:3/4; background:#111; border:2px solid var(--accent); border-radius:var(--radius); overflow:hidden}
    .row{display:flex; gap:.6rem; align-items:center; flex-wrap:wrap; margin:.5rem 0 1rem}
    button,.btn{background:var(--accent-2); color:var(--ink); border:1px solid var(--accent);
      padding:.6rem .9rem; border-radius:12px; cursor:pointer; text-decoration:none; display:inline-flex; align-items:center; gap:.4rem}
    button:hover,.btn:hover{background:var(--accent); color:#0b0f0c}
    .hint{color:var(--muted); font-size:.95rem; margin-top:.5rem}
  </style>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
</head>
<body>
  <main class="wrap">
    <h1>Escanear QR — Guía con videos</h1>
    <div class="card">
      <div id="reader"></div>
      <div class="row">
        <button id="stopBtn" disabled>Detener</button>
        <a class="btn" href="/">Volver al inicio</a>
      </div>
      <div class="hint">Si el navegador pide permiso, aceptá el uso de la cámara. En iOS abrí con Safari; en Android, con Chrome.</div>
    </div>
  </main>

  <script>
    const stopBtn = document.getElementById('stopBtn');
    let html5QrCode = null;
    let scanning = false;

    function onScanSuccess(decodedText) {
      if (decodedText.startsWith("http://") || decodedText.startsWith("https://") || decodedText.startsWith("/")) {
        window.location.href = decodedText;
        return;
      }
      alert("Código leído: " + decodedText);
    }

    async function startWithRearCamera() {
      html5QrCode = html5QrCode || new Html5Qrcode("reader", { verbose: false });
      const config = { fps: 15, qrbox: { width: 280, height: 280 }, aspectRatio: 1.333, focusMode: "continuous" };

      // 1) Intento directo: facingMode "environment"
      try {
        await html5QrCode.start({ facingMode: { exact: "environment" } }, config, onScanSuccess, () => {});
        scanning = true; stopBtn.disabled = false;
        return;
      } catch (e) {
        // continúa al fallback
      }

      // 2) Fallback: buscar una cámara "trasera" en la lista de dispositivos
      try {
        const devices = await Html5Qrcode.getCameras();
        if (!devices || devices.length === 0) throw new Error("No hay cámaras disponibles.");

        // Buscar por label palabras clave típicas
        const rear = devices.find(d => /back|rear|environment|trase|atrás|posterior/i.test(d.label)) 
                  || devices[devices.length - 1]; // última suele ser trasera en móviles

        await html5QrCode.start({ deviceId: { exact: rear.id } }, config, onScanSuccess, () => {});
        scanning = true; stopBtn.disabled = false;
      } catch (err) {
        console.error(err);
        alert("No se pudo iniciar la cámara trasera. Revisá permisos del navegador.");
      }
    }

    async function stopScan() {
      if (html5QrCode && scanning) {
        await html5QrCode.stop();
        await html5QrCode.clear();
        scanning = false;
        stopBtn.disabled = true;
      }
    }

    // Intentar iniciar automáticamente al abrir la página
    document.addEventListener('DOMContentLoaded', () => {
      startWithRearCamera().catch(err => {
        console.error(err);
        // Algunos navegadores requieren interacción del usuario;
        // en ese caso, habilitamos el botón Detener/Volver a intentar manualmente si quisieras agregar uno de "Iniciar".
      });
    });

    stopBtn.addEventListener('click', stopScan);
  </script>
</body>
</html>



